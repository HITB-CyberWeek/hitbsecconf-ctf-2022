# KV
## Service Description
KV is a simple key-value storage with 3 endpoints

* ```POST /register``` returns ```client_id``` and ```client_secret```
* ```PUT /kv/{filename}``` to put data
* ```GET /kv/{filename}``` to get data

PUT and GET endpoints requires valid credentials in headers ```X-Client-ID``` and ```X-Client-Secret```  to proceed

Service uses Redis to store data:
* Users' credentials are stored in the special key '0'
* Data is stored in key which is generated by hash function: ```uint64(sha256(uint16(clientId) + bytes(filename))[-8:])```. See [golang code](https://github.com/HITB-CyberWeek/hitbsecconf-ctf-2022/blob/main/services/kv/stor.go#L59) for details.

### Register
```
$ curl -X POST https://kv.team21.ctf.hitb.org/register
{"client_id":"2502","client_secret":"96c00edfccaa9f692cda5718177051729b1459eae9390bb68ec00535f38db45c"}
```

### PUT
```
$ curl -X PUT -H 'X-Client-ID:2502' -H 'X-Client-Secret:96c00edfccaa9f692cda5718177051729b1459eae9390bb68ec00535f38db45c' --data 'FLAGFLAGFLAG' https://kv.team21.ctf.hitb.org/kv/test_filename
```

### GET
```
$ curl -X GET -H 'X-Client-ID:2502' -H 'X-Client-Secret:96c00edfccaa9f692cda5718177051729b1459eae9390bb68ec00535f38db45c' https://kv.team21.ctf.hitb.org/kv/test_filename
{"headers":{"Content-Length":"12","Content-Type":"application/x-www-form-urlencoded","X-Forwarded-Proto":"https"},"content":"FLAGFLAGFLAG"}
```

## Vulnerability Description
#### TLDR
0. You should somehow get data from special Redis key ```0``` to get all users' credentials
1. Redis key is a hash from client_id and filename. So, you should generate such filename wich makes  ```hash(client_id + filename)``` an integer ending 8 zero bytes and then GET the filename.
2. You can find a lot of hashes _ending_ with 8 zero bytes in bitcoin blocks data.
3. After you get all client_ids and secrets, you can get any filename from the service (if you know filename :)
4. During the competition you can get flag filenames using checksystem's [public flag id API](https://2022.ctf.hitb.org/hitb-ctf-singapore-2022/api).

#### More details
Let's see how to find proper filename to get 0-ending hash using bitcoin blocks.

Bitcoin hash is

```hash = sha256(sha256(Block_Header))```

So you should find such ```Block_header``` which sha256(Block_Header) starts with ```uint16(client_id)``` (bitcoin hashes always ends with a lot of zeros)

Note. If you get [random bitcoin block](https://www.blockchain.com/btc/block/125552) you may see that the hash is _starting_ with zeros, not _ending_ with zeros. This because the hash is reversed at the last step of hash computation (acording to [block hashing algorithm](https://en.bitcoin.it/wiki/Block_hashing_algorithm)).

See Bitcoin [block hashing algorithm](https://en.bitcoin.it/wiki/Block_hashing_algorithm) for detais.

Use can file bitcoin blocks dumps at [Blockchair dumps site](https://gz.blockchair.com/bitcoin/blocks/) (or in many other places).

## Exploit
See [sploits/kv/exploit.py](https://github.com/HITB-CyberWeek/hitbsecconf-ctf-2022/blob/main/sploits/kv/exploit.py).

Download blockchain blocks to ```blocks/``` dir before running the exploit. See [README.md](https://github.com/HITB-CyberWeek/hitbsecconf-ctf-2022/blob/main/sploits/kv/blocks/README.md) for details.

```
./exploit.py --url_prefix https://kv.team21.ctf.hitb.org --filename flag_filename --client_id 1337
```
