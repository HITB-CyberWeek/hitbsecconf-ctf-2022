version: 1
service: wallet
username: wallet

scripts:
  build_inside_vm: |
    apt-get update
    apt-get install openssl
    docker compose -f /home/wallet/docker-compose.yml build --pull
  start_once: |
    echo "MYSQL_USERNAME=root" > /home/$USERNAME/.env
    echo "MYSQL_ROOT_PASSWORD=$(openssl rand -hex 16)" >> /home/$USERNAME/.env
    echo "MYSQL_DATABASE=wallet" >> /home/$USERNAME/.env
    echo "MYSQL_HOST=mysql" >> /home/$USERNAME/.env
    docker compose -f /home/wallet/docker-compose.yml up -d

files:
  - sources:
      - ./docker-compose.yml
      - ./www
      - ./docker
    destination: /home/wallet

proxies:
  - name: main
    listener:
      protocol: http    
      certificate: wildcard.ctf.hitb.org
    upstream:
      host_index: 11
      port: 80    
    limits:
      - source: team
        location: /
        limit: 5r/m
        burst: 5
    dns_records:
      - wallet